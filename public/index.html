<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>除夕联机游戏房</title>
    <style>
      :root {
        --bg0: #210606;
        --bg1: #6d1413;
        --line: rgba(255, 221, 161, 0.36);
        --panel: rgba(255, 241, 220, 0.12);
        --panel-strong: rgba(255, 241, 220, 0.2);
        --text: #fff8ea;
        --muted: #ffd8a2;
        --ok: #c9ffd8;
        --bad: #ffd2d2;
        --gold: #ffd35c;
        --orange: #ff9f37;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        margin: 0;
        width: 100%;
        min-height: 100%;
        font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at 8% 9%, #8a1f16 0%, transparent 36%),
          radial-gradient(circle at 92% 4%, #a63a1c 0%, transparent 32%),
          linear-gradient(165deg, var(--bg0), var(--bg1));
      }

      body {
        display: flex;
        justify-content: center;
        padding: max(12px, env(safe-area-inset-top)) 12px max(18px, env(safe-area-inset-bottom));
      }

      .app {
        width: min(760px, 100%);
        display: grid;
        gap: 12px;
      }

      .panel {
        border-radius: 16px;
        border: 1px solid var(--line);
        background: linear-gradient(150deg, var(--panel-strong), var(--panel));
        padding: 14px;
      }

      .hero {
        text-align: center;
        display: grid;
        gap: 8px;
      }

      .hero h1,
      .hero p {
        margin: 0;
      }

      .hero h1 {
        font-size: clamp(25px, 7vw, 38px);
      }

      .hero p {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.5;
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .inputs {
        margin-top: 12px;
        display: grid;
        gap: 10px;
      }

      label {
        display: grid;
        gap: 7px;
        font-size: 13px;
        color: #ffe8c5;
        font-weight: 700;
      }

      input,
      select,
      button,
      textarea {
        font-family: inherit;
      }

      input,
      select,
      textarea {
        width: 100%;
        border: 1px solid rgba(255, 220, 160, 0.35);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.24);
        color: var(--text);
        padding: 10px 12px;
        font-size: 16px;
        outline: none;
      }

      textarea {
        resize: none;
      }

      .btn {
        border: 0;
        border-radius: 12px;
        padding: 11px 13px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        background: linear-gradient(120deg, var(--gold), var(--orange));
        color: #641705;
      }

      .btn.secondary {
        background: rgba(255, 242, 219, 0.12);
        border: 1px solid var(--line);
        color: #ffe5ba;
      }

      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .small {
        font-size: 13px;
        color: var(--muted);
      }

      .hidden {
        display: none !important;
      }

      .rooms {
        margin-top: 8px;
        display: grid;
        gap: 8px;
      }

      .room-item {
        border: 1px solid rgba(255, 219, 149, 0.28);
        border-radius: 11px;
        background: rgba(0, 0, 0, 0.2);
        padding: 9px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .room-top {
        display: grid;
        gap: 8px;
      }

      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .code {
        font-size: 21px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .pill {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 4px 9px;
        font-size: 12px;
        color: #ffe7c0;
      }

      .hint {
        min-height: 22px;
        font-weight: 700;
      }

      .hint.ok {
        color: var(--ok);
      }

      .hint.bad {
        color: var(--bad);
      }

      .scoreboard {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .player {
        border: 1px solid rgba(255, 220, 156, 0.24);
        border-radius: 10px;
        padding: 8px 10px;
        background: rgba(0, 0, 0, 0.22);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player.self {
        border-color: rgba(255, 237, 171, 0.92);
        box-shadow: 0 0 0 1px rgba(255, 237, 171, 0.45) inset;
      }

      .player .meta {
        font-size: 12px;
        color: #ffe2b7;
      }

      .section-title {
        margin: 0;
        font-size: 16px;
      }

      .setup-box {
        margin-top: 10px;
        display: grid;
        gap: 10px;
        border: 1px solid rgba(255, 219, 148, 0.24);
        border-radius: 12px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.18);
      }

      .game-panel {
        margin-top: 12px;
      }

      .question-title {
        margin: 0;
        font-size: 20px;
        font-weight: 800;
      }

      .options {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .opt {
        width: 100%;
        text-align: left;
        border: 1px solid rgba(255, 220, 156, 0.35);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        border-radius: 12px;
        padding: 11px 12px;
        font-size: 15px;
        font-weight: 700;
      }

      .opt.correct {
        border-color: rgba(186, 255, 203, 0.95);
        background: rgba(76, 166, 95, 0.27);
      }

      .opt.wrong {
        border-color: rgba(255, 182, 182, 0.95);
        background: rgba(166, 76, 76, 0.27);
      }

      .memory-board {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }

      .memory-card {
        border: 1px solid rgba(255, 220, 156, 0.35);
        border-radius: 12px;
        aspect-ratio: 3 / 4;
        background: linear-gradient(150deg, rgba(119, 14, 14, 0.58), rgba(66, 8, 8, 0.75));
        color: #ffd8a2;
        font-size: clamp(20px, 6vw, 32px);
        font-weight: 800;
        display: grid;
        place-items: center;
      }

      .memory-card.open,
      .memory-card.done {
        background: linear-gradient(150deg, #fff2cf, #ffd98e);
        color: #7c1808;
      }

      .draw-wrap {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .draw-canvas {
        width: 100%;
        aspect-ratio: 16 / 10;
        border-radius: 12px;
        border: 1px solid rgba(255, 220, 156, 0.35);
        background: #fff8eb;
        touch-action: none;
      }

      .guess-list {
        display: grid;
        gap: 6px;
      }

      .guess-item {
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
        padding: 6px 8px;
        font-size: 13px;
        color: #ffe7bf;
      }

      .guess-item.ok {
        color: #d6ffd4;
      }

      .footer {
        text-align: center;
        color: #ffd8a4;
        font-size: 12px;
      }

      @media (max-width: 560px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section id="lobbyView" class="panel">
        <header class="hero">
          <h1>除夕联机游戏房</h1>
          <p>首页只做创建/加入和大厅浏览。进房间后再由房主选择具体游戏与配置。</p>
        </header>

        <div class="inputs">
          <label>
            你的昵称
            <input id="nameInput" maxlength="16" placeholder="例如：阿明" />
          </label>
          <div class="grid2">
            <label>
              房间名（创建时）
              <input id="titleInput" maxlength="24" placeholder="我们家除夕局" />
            </label>
            <label>
              房间码（加入时）
              <input id="codeInput" maxlength="6" placeholder="输入 6 位房间码" />
            </label>
          </div>
          <div class="grid2">
            <button id="createBtn" class="btn">创建房间</button>
            <button id="joinBtn" class="btn secondary">加入房间</button>
          </div>
          <button id="refreshBtn" class="btn secondary">刷新大厅</button>
        </div>

        <p class="small" style="margin-top: 12px">大厅房间列表：</p>
        <div id="roomList" class="rooms"></div>
        <p id="lobbyHint" class="hint"></p>
      </section>

      <section id="roomView" class="panel hidden">
        <div class="room-top">
          <div class="row">
            <div>
              <div id="roomCode" class="code">------</div>
              <div id="roomTitle" class="small">房间</div>
            </div>
            <div class="row">
              <span id="stageTag" class="pill">等待开始</span>
              <button id="copyBtn" class="btn secondary">复制房间码</button>
              <button id="leaveBtn" class="btn secondary">离开房间</button>
            </div>
          </div>
          <div class="row">
            <div id="hostText" class="small">房主：-</div>
            <div id="gameText" class="small">游戏：-</div>
            <div id="roundText" class="small">回合：-</div>
            <div id="timerText" class="small">倒计时：-- 秒</div>
          </div>
        </div>

        <section class="setup-box">
          <h2 class="section-title">游戏配置（房间内设置）</h2>
          <div class="grid2">
            <label>
              选择游戏
              <select id="gameSelect">
                <option value="memory">翻牌冲刺（各玩各的）</option>
                <option value="draw">你画我猜</option>
                <option value="quiz">快问快答</option>
                <option value="rotate">游戏轮换（翻牌→你画我猜→快问快答）</option>
              </select>
            </label>
            <label>
              回合数
              <input id="roundsInput" type="number" min="1" max="12" value="3" />
            </label>
          </div>
          <label>
            每回合时长（秒）
            <input id="secondsInput" type="number" min="10" max="120" value="20" />
          </label>
          <div id="limitsText" class="small">当前游戏建议范围：-</div>
          <div class="grid2">
            <button id="saveSetupBtn" class="btn secondary">保存配置</button>
            <button id="startBtn" class="btn">房主开始</button>
          </div>
          <button id="backLobbyBtn" class="btn secondary hidden">回到房间大厅（重开）</button>
        </section>

        <div id="scoreboard" class="scoreboard"></div>

        <section id="quizPanel" class="game-panel hidden">
          <div id="quizLabel" class="small">快问快答</div>
          <p id="quizQuestion" class="question-title">题目</p>
          <div id="quizOptions" class="options"></div>
        </section>

        <section id="memoryPanel" class="game-panel hidden">
          <div class="small">翻牌冲刺：每人手机独立翻牌，匹配越多分越高，分数实时上传。</div>
          <div class="row" style="margin-top: 6px">
            <div id="memoryLocalScore" class="small">我的本回合分数：0</div>
            <button id="memoryResetBtn" class="btn secondary">重置本回合棋盘</button>
          </div>
          <div id="memoryBoard" class="memory-board"></div>
        </section>

        <section id="drawPanel" class="game-panel hidden">
          <div id="drawRoleText" class="small">你是：-</div>
          <div id="drawWordText" class="small">本轮词语：-</div>
          <div class="draw-wrap">
            <canvas id="drawCanvas" class="draw-canvas"></canvas>
            <div class="row">
              <button id="drawClearBtn" class="btn secondary">清空画板</button>
            </div>
            <div id="drawGuessBox" class="grid2 hidden">
              <input id="drawGuessInput" maxlength="24" placeholder="输入你的猜词" />
              <button id="drawGuessBtn" class="btn">发送猜词</button>
            </div>
            <div id="drawGuessList" class="guess-list"></div>
          </div>
        </section>

        <p id="roomHint" class="hint"></p>
      </section>

      <p class="footer">直接访问：`http://你的IP:3000/`，无需再输入长路径。</p>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io({ autoConnect: false });

      const GAME_LABEL = {
        quiz: '快问快答',
        memory: '翻牌冲刺',
        draw: '你画我猜',
        rotate: '游戏轮换'
      };

      const GAME_LIMITS = {
        quiz: { roundsMin: 3, roundsMax: 12, secMin: 8, secMax: 25 },
        memory: { roundsMin: 1, roundsMax: 8, secMin: 10, secMax: 45 },
        draw: { roundsMin: 1, roundsMax: 12, secMin: 20, secMax: 120 },
        rotate: { roundsMin: 3, roundsMax: 18, secMin: 10, secMax: 60 }
      };

      const MEMORY_SYMBOLS = ['福', '春', '喜', '财', '旺', '安'];

      const lobbyView = document.getElementById('lobbyView');
      const roomView = document.getElementById('roomView');
      const nameInput = document.getElementById('nameInput');
      const titleInput = document.getElementById('titleInput');
      const codeInput = document.getElementById('codeInput');
      const createBtn = document.getElementById('createBtn');
      const joinBtn = document.getElementById('joinBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const roomList = document.getElementById('roomList');
      const lobbyHint = document.getElementById('lobbyHint');

      const roomCode = document.getElementById('roomCode');
      const roomTitle = document.getElementById('roomTitle');
      const stageTag = document.getElementById('stageTag');
      const hostText = document.getElementById('hostText');
      const gameText = document.getElementById('gameText');
      const roundText = document.getElementById('roundText');
      const timerText = document.getElementById('timerText');
      const copyBtn = document.getElementById('copyBtn');
      const leaveBtn = document.getElementById('leaveBtn');
      const roomHint = document.getElementById('roomHint');

      const gameSelect = document.getElementById('gameSelect');
      const roundsInput = document.getElementById('roundsInput');
      const secondsInput = document.getElementById('secondsInput');
      const limitsText = document.getElementById('limitsText');
      const saveSetupBtn = document.getElementById('saveSetupBtn');
      const startBtn = document.getElementById('startBtn');
      const backLobbyBtn = document.getElementById('backLobbyBtn');

      const scoreboard = document.getElementById('scoreboard');

      const quizPanel = document.getElementById('quizPanel');
      const quizLabel = document.getElementById('quizLabel');
      const quizQuestion = document.getElementById('quizQuestion');
      const quizOptions = document.getElementById('quizOptions');

      const memoryPanel = document.getElementById('memoryPanel');
      const memoryLocalScore = document.getElementById('memoryLocalScore');
      const memoryResetBtn = document.getElementById('memoryResetBtn');
      const memoryBoard = document.getElementById('memoryBoard');

      const drawPanel = document.getElementById('drawPanel');
      const drawRoleText = document.getElementById('drawRoleText');
      const drawWordText = document.getElementById('drawWordText');
      const drawCanvas = document.getElementById('drawCanvas');
      const drawClearBtn = document.getElementById('drawClearBtn');
      const drawGuessBox = document.getElementById('drawGuessBox');
      const drawGuessInput = document.getElementById('drawGuessInput');
      const drawGuessBtn = document.getElementById('drawGuessBtn');
      const drawGuessList = document.getElementById('drawGuessList');

      let selfId = '';
      let lobbyRooms = [];
      let roomState = null;
      let drawSecretWord = '';
      let roomTimer = null;
      let lobbyPullTimer = null;

      let memoryDeck = [];
      let memoryOpen = [];
      let memoryMatched = new Set();
      let memoryScore = 0;
      let memoryRoundKey = '';
      let memoryLastPushAt = 0;

      let drawCtx = null;
      let drawLineActive = false;
      let drawLastPoint = null;
      let drawRoundKey = '';

      function saveName() {
        localStorage.setItem('party_name', nameInput.value.trim());
      }

      function loadName() {
        const n = localStorage.getItem('party_name') || '';
        if (n) nameInput.value = n;
      }

      function applyHint(el, text, type) {
        el.textContent = text || '';
        el.className = 'hint ' + (type || '');
      }

      function setHint(scope, text, type) {
        if (scope === 'lobby') {
          applyHint(lobbyHint, text, type);
          return;
        }
        applyHint(roomHint, text, type);
      }

      function stageText(stage) {
        if (stage === 'lobby') return '等待开始';
        if (stage === 'playing') return '游戏进行中';
        if (stage === 'result') return '本局已结束';
        return stage || '-';
      }

      function activeGameType(room) {
        if (!room || !room.game) return null;
        return room.game.currentGameType || room.game.type || null;
      }

      function activeGameLabel(room) {
        if (!room || !room.game) return '-';
        return room.game.currentGameLabel || room.game.label || GAME_LABEL[activeGameType(room)] || '-';
      }

      function openLobby() {
        roomView.classList.add('hidden');
        lobbyView.classList.remove('hidden');
      }

      function openRoom() {
        lobbyView.classList.add('hidden');
        roomView.classList.remove('hidden');
      }

      function validateName() {
        const name = nameInput.value.trim();
        if (!name) {
          setHint('lobby', '请先输入昵称', 'bad');
          return false;
        }
        saveName();
        return true;
      }

      function copyText(value) {
        const text = String(value || '');
        if (!text) return;

        const fallbackCopy = () => {
          const area = document.createElement('textarea');
          area.value = text;
          area.style.position = 'fixed';
          area.style.left = '-9999px';
          document.body.appendChild(area);
          area.focus();
          area.select();
          let ok = false;
          try {
            ok = document.execCommand('copy');
          } catch (e) {
            ok = false;
          }
          document.body.removeChild(area);
          return ok;
        };

        const onFail = () => {
          if (fallbackCopy()) {
            setHint('room', '房间码已复制', 'ok');
            return;
          }
          setHint('room', '复制失败，请手动复制：' + text, 'bad');
          window.prompt('请手动复制房间码', text);
        };

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
            setHint('room', '房间码已复制', 'ok');
          }).catch(onFail);
          return;
        }

        onFail();
      }

      function renderLobby() {
        roomList.innerHTML = '';
        if (!lobbyRooms.length) {
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = '暂无房间，先创建一个吧。';
          roomList.appendChild(empty);
          return;
        }

        lobbyRooms.forEach((r) => {
          const item = document.createElement('div');
          item.className = 'room-item';
          item.innerHTML =
            '<div><strong>' +
            r.title +
            '</strong><div class="small">房间码：' +
            r.code +
            ' ｜ ' +
            (r.selectedGameLabel || GAME_LABEL[r.selectedGame] || '未设置') +
            ' ｜ ' +
            stageText(r.stage) +
            ' ｜ ' +
            r.players +
            ' 人</div></div><button class="btn secondary">加入</button>';

          item.querySelector('button').addEventListener('click', () => {
            codeInput.value = r.code;
            joinRoom();
          });
          roomList.appendChild(item);
        });
      }

      function gameLimitsText(type) {
        const l = GAME_LIMITS[type] || GAME_LIMITS.memory;
        return '当前游戏建议范围：回合 ' + l.roundsMin + '-' + l.roundsMax + '，每回合 ' + l.secMin + '-' + l.secMax + ' 秒';
      }

      function syncSetupFields(room) {
        if (!room || !room.setup) return;
        gameSelect.value = room.setup.selectedGame;
        roundsInput.value = room.setup.rounds;
        secondsInput.value = room.setup.seconds;
        limitsText.textContent = gameLimitsText(room.setup.selectedGame);
      }

      function clampSetupForSend(type, rounds, seconds) {
        const l = GAME_LIMITS[type] || GAME_LIMITS.memory;
        return {
          selectedGame: type,
          rounds: Math.max(l.roundsMin, Math.min(l.roundsMax, Number(rounds) || l.roundsMin)),
          seconds: Math.max(l.secMin, Math.min(l.secMax, Number(seconds) || l.secMin)),
        };
      }

      function currentSetupFromInputs() {
        return clampSetupForSend(gameSelect.value, roundsInput.value, secondsInput.value);
      }

      function renderScoreboard(room) {
        scoreboard.innerHTML = '';
        const list = [...room.players].sort((a, b) => b.score - a.score);

        list.forEach((p) => {
          const row = document.createElement('div');
          row.className = 'player' + (p.id === selfId ? ' self' : '');
          row.innerHTML =
            '<div><strong>' +
            p.name +
            (p.isHost ? '（房主）' : '') +
            '</strong><div class="meta">答对 ' +
            p.correct +
            ' · 答错 ' +
            p.wrong +
            (p.roundScore ? ' · 本回合 +' + p.roundScore : '') +
            '</div></div><strong>' +
            p.score +
            ' 分</strong>';
          scoreboard.appendChild(row);
        });
      }

      function renderQuiz(room) {
        quizPanel.classList.remove('hidden');
        memoryPanel.classList.add('hidden');
        drawPanel.classList.add('hidden');

        const game = room.game;
        if (!game) return;

        quizLabel.textContent = game.label + ' · 第 ' + game.roundNo + '/' + game.totalRounds + ' 题';
        quizQuestion.textContent = game.question || '题目加载中...';
        quizOptions.innerHTML = '';

        const me = room.players.find((p) => p.id === selfId);
        const answered = Boolean(me && me.answered);

        (game.options || []).forEach((opt, idx) => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'opt';
          b.textContent = String.fromCharCode(65 + idx) + '. ' + opt;

          if (game.phase === 'quiz_question') {
            b.disabled = answered || room.stage !== 'playing';
            b.addEventListener('click', () => {
              socket.emit('partyAnswer', { choice: idx });
            });
          } else {
            b.disabled = true;
            if (idx === game.correctIndex) {
              b.classList.add('correct');
            }
            if (me && me.answerChoice === idx && idx !== game.correctIndex) {
              b.classList.add('wrong');
            }
          }

          quizOptions.appendChild(b);
        });
      }

      function shuffle(list) {
        const arr = [...list];
        for (let i = arr.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          const t = arr[i];
          arr[i] = arr[j];
          arr[j] = t;
        }
        return arr;
      }

      function initMemoryBoard(roundKey) {
        const cards = shuffle([...MEMORY_SYMBOLS, ...MEMORY_SYMBOLS]);
        memoryDeck = cards.map((s, idx) => ({ id: idx + 1, symbol: s, open: false, done: false }));
        memoryOpen = [];
        memoryMatched = new Set();
        memoryScore = 0;
        memoryRoundKey = roundKey;
        memoryLocalScore.textContent = '我的本回合分数：0';
        renderMemoryBoard();
        pushMemoryScore(true);
      }

      function renderMemoryBoard() {
        memoryBoard.innerHTML = '';
        memoryDeck.forEach((card, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'memory-card' + (card.open ? ' open' : '') + (card.done ? ' done' : '');
          btn.textContent = card.open || card.done ? card.symbol : '囍';
          btn.addEventListener('click', () => onMemoryCardTap(idx));
          memoryBoard.appendChild(btn);
        });
      }

      function canPlayMemory() {
        if (!roomState || !roomState.room || !roomState.room.game) return false;
        const room = roomState.room;
        return room.stage === 'playing' && activeGameType(room) === 'memory' && room.game.phase === 'memory_play';
      }

      function pushMemoryScore(force) {
        const now = Date.now();
        if (!force && now - memoryLastPushAt < 120) return;
        memoryLastPushAt = now;
        socket.emit('partyMemoryUpdate', { score: memoryScore });
      }

      function onMemoryCardTap(index) {
        if (!canPlayMemory()) return;
        const card = memoryDeck[index];
        if (!card || card.done || card.open) return;
        if (memoryOpen.length >= 2) return;

        card.open = true;
        memoryOpen.push(index);
        renderMemoryBoard();

        if (memoryOpen.length < 2) return;

        const [a, b] = memoryOpen;
        const c1 = memoryDeck[a];
        const c2 = memoryDeck[b];

        if (c1.symbol === c2.symbol) {
          c1.done = true;
          c2.done = true;
          memoryMatched.add(c1.id);
          memoryMatched.add(c2.id);
          memoryScore += 10;
          memoryLocalScore.textContent = '我的本回合分数：' + memoryScore;
          memoryOpen = [];
          renderMemoryBoard();
          pushMemoryScore(false);
          return;
        }

        memoryScore = Math.max(0, memoryScore - 2);
        memoryLocalScore.textContent = '我的本回合分数：' + memoryScore;
        pushMemoryScore(false);

        setTimeout(() => {
          c1.open = false;
          c2.open = false;
          memoryOpen = [];
          renderMemoryBoard();
        }, 430);
      }

      function renderMemory(room) {
        quizPanel.classList.add('hidden');
        memoryPanel.classList.remove('hidden');
        drawPanel.classList.add('hidden');

        const game = room.game;
        if (!game) return;

        const roundKey = room.code + ':' + game.roundNo + ':' + game.phase;
        if (memoryRoundKey !== roundKey && game.phase === 'memory_play') {
          initMemoryBoard(roundKey);
        }

        if (game.phase !== 'memory_play') {
          memoryResetBtn.disabled = true;
        } else {
          memoryResetBtn.disabled = false;
        }
      }

      function ensureCanvas() {
        if (!drawCtx) {
          drawCtx = drawCanvas.getContext('2d');
        }
        const dpr = window.devicePixelRatio || 1;
        const rect = drawCanvas.getBoundingClientRect();
        const w = Math.max(1, Math.floor(rect.width * dpr));
        const h = Math.max(1, Math.floor(rect.height * dpr));
        if (drawCanvas.width !== w || drawCanvas.height !== h) {
          drawCanvas.width = w;
          drawCanvas.height = h;
          drawCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
          drawCtx.lineCap = 'round';
          drawCtx.lineJoin = 'round';
          clearDrawCanvas();
        }
      }

      function clearDrawCanvas() {
        ensureCanvas();
        drawCtx.fillStyle = '#fff8eb';
        drawCtx.fillRect(0, 0, drawCanvas.clientWidth, drawCanvas.clientHeight);
      }

      function drawLine(payload) {
        ensureCanvas();
        const w = drawCanvas.clientWidth;
        const h = drawCanvas.clientHeight;
        drawCtx.strokeStyle = payload.color || '#2c0505';
        drawCtx.lineWidth = payload.size || 4;
        drawCtx.beginPath();
        drawCtx.moveTo(payload.x0 * w, payload.y0 * h);
        drawCtx.lineTo(payload.x1 * w, payload.y1 * h);
        drawCtx.stroke();
      }

      function pointOnCanvas(e) {
        const rect = drawCanvas.getBoundingClientRect();
        return {
          x: Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width)),
          y: Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height)),
        };
      }

      function isDrawer(room) {
        return Boolean(room && room.game && activeGameType(room) === 'draw' && room.game.drawerId === selfId);
      }

      function canDrawNow(room) {
        return room && room.stage === 'playing' && room.game && activeGameType(room) === 'draw' && room.game.phase === 'draw_play' && isDrawer(room);
      }

      function renderDraw(room) {
        quizPanel.classList.add('hidden');
        memoryPanel.classList.add('hidden');
        drawPanel.classList.remove('hidden');

        ensureCanvas();

        const game = room.game;
        if (!game) return;

        const key = room.code + ':' + game.roundNo + ':' + game.phase;
        if (key !== drawRoundKey) {
          drawRoundKey = key;
          clearDrawCanvas();
          if (!(game.phase === 'draw_play' && isDrawer(room))) {
            drawSecretWord = '';
          }
        }

        const amDrawer = isDrawer(room);
        drawRoleText.textContent = amDrawer ? '你是画手，请画给大家猜。' : '你是猜词玩家，观察画板后输入猜词。';

        if (game.phase === 'draw_play') {
          drawWordText.textContent = amDrawer ? ('本轮词语：' + (drawSecretWord || '（等待下发）')) : '本轮词语：画手正在作画';
        } else {
          drawWordText.textContent = '本轮词语：' + (game.revealWord || '-');
        }

        drawClearBtn.disabled = !(amDrawer && game.phase === 'draw_play');
        drawGuessBox.classList.toggle('hidden', amDrawer || game.phase !== 'draw_play');

        drawGuessList.innerHTML = '';
        (game.guesses || []).slice(-8).forEach((g) => {
          const row = document.createElement('div');
          row.className = 'guess-item' + (g.ok ? ' ok' : '');
          row.textContent = g.name + '：' + g.text + (g.ok ? '（猜中）' : '');
          drawGuessList.appendChild(row);
        });
      }

      function renderGameArea(room) {
        if (!room.game) {
          quizPanel.classList.add('hidden');
          memoryPanel.classList.add('hidden');
          drawPanel.classList.add('hidden');
          return;
        }

        const kind = activeGameType(room);
        if (kind === 'quiz') {
          renderQuiz(room);
          return;
        }
        if (kind === 'memory') {
          renderMemory(room);
          return;
        }
        renderDraw(room);
      }

      function renderRoom() {
        if (!roomState || !roomState.room) {
          openLobby();
          return;
        }

        const room = roomState.room;
        openRoom();

        roomCode.textContent = room.code;
        roomTitle.textContent = room.title;
        stageTag.textContent = stageText(room.stage);
        hostText.textContent = '房主：' + room.hostName;
        const setupLabel = room.setup ? room.setup.selectedGameLabel : '-';
        const currentLabel = room.stage === 'playing' ? activeGameLabel(room) : null;
        gameText.textContent = currentLabel ? ('游戏：' + setupLabel + ' · 当前回合：' + currentLabel) : ('游戏：' + setupLabel);

        if (room.game) {
          roundText.textContent = '回合：' + room.game.roundNo + '/' + room.game.totalRounds;
        } else {
          roundText.textContent = '回合：-';
        }

        const me = room.players.find((p) => p.id === selfId);
        const amHost = Boolean(me && me.isHost);

        syncSetupFields(room);

        const canEdit = amHost && room.stage !== 'playing';
        gameSelect.disabled = !canEdit;
        roundsInput.disabled = !canEdit;
        secondsInput.disabled = !canEdit;
        saveSetupBtn.disabled = !canEdit;
        startBtn.disabled = !(amHost && room.stage !== 'playing');
        backLobbyBtn.classList.toggle('hidden', !(amHost && room.stage === 'result'));

        renderScoreboard(room);
        renderGameArea(room);

        if (room.stage === 'lobby') {
          setHint('room', amHost ? '房主请先设置游戏，再点击开始。' : '等待房主配置并开始。', '');
        } else if (room.stage === 'playing') {
          const kind = activeGameType(room);
          if (kind === 'quiz') {
            setHint('room', me && me.answered ? '已作答，等待其他玩家...' : '请选择一个选项提交答案。', '');
          } else if (kind === 'memory') {
            setHint('room', '翻牌冲刺中：每个人在自己手机上尽快刷分。', '');
          } else {
            setHint('room', '你画我猜进行中。', '');
          }
        } else {
          setHint('room', amHost ? '本局结束，你可以回到房间大厅修改配置再开一局。' : '本局结束，等待房主重开。', 'ok');
        }
      }

      function updateRoomTimer() {
        if (!roomState || !roomState.room || !roomState.room.game) {
          timerText.textContent = '倒计时：-- 秒';
          return;
        }

        const g = roomState.room.game;
        if (!g.roundEndsAt || roomState.room.stage !== 'playing') {
          timerText.textContent = '倒计时：-- 秒';
          return;
        }

        const left = Math.max(0, Math.ceil((g.roundEndsAt - Date.now()) / 1000));
        timerText.textContent = '倒计时：' + left + ' 秒';
      }

      async function fetchLobbyFromHttp() {
        try {
          const res = await fetch('/api/lobby', { cache: 'no-store' });
          if (!res.ok) return;
          const data = await res.json();
          lobbyRooms = data.rooms || [];
          if (lobbyView.classList.contains('hidden')) return;
          renderLobby();
        } catch (_) {
          // ignore
        }
      }

      function createRoom() {
        if (!validateName()) return;
        socket.emit('partyCreateRoom', {
          name: nameInput.value.trim(),
          title: titleInput.value.trim(),
        });
      }

      function joinRoom() {
        if (!validateName()) return;
        const code = codeInput.value.trim().toUpperCase();
        if (!/^[A-Z0-9]{6}$/.test(code)) {
          setHint('lobby', '房间码应为 6 位字母数字', 'bad');
          return;
        }
        socket.emit('partyJoinRoom', {
          code,
          name: nameInput.value.trim(),
        });
      }

      function saveSetup() {
        if (!roomState || !roomState.room) return;
        const send = currentSetupFromInputs();
        socket.emit('partyUpdateSetup', send);
      }

      function startGame() {
        const send = currentSetupFromInputs();
        socket.emit('partyStart', send);
      }

      function backToRoomLobby() {
        socket.emit('partyBackLobby');
      }

      function sendGuess() {
        const text = drawGuessInput.value.trim();
        if (!text) return;
        socket.emit('partyDrawGuess', { text });
        drawGuessInput.value = '';
      }

      createBtn.addEventListener('click', createRoom);
      joinBtn.addEventListener('click', joinRoom);
      refreshBtn.addEventListener('click', () => {
        socket.emit('partyListRooms');
        fetchLobbyFromHttp();
      });

      copyBtn.addEventListener('click', () => {
        if (!roomState || !roomState.room) return;
        copyText(roomState.room.code);
      });

      leaveBtn.addEventListener('click', () => {
        socket.emit('partyLeaveRoom');
        roomState = null;
        drawSecretWord = '';
        openLobby();
        setHint('lobby', '已离开房间', '');
      });

      gameSelect.addEventListener('change', () => {
        limitsText.textContent = gameLimitsText(gameSelect.value);
      });

      saveSetupBtn.addEventListener('click', saveSetup);
      startBtn.addEventListener('click', startGame);
      backLobbyBtn.addEventListener('click', backToRoomLobby);

      memoryResetBtn.addEventListener('click', () => {
        if (!roomState || !roomState.room || !roomState.room.game || activeGameType(roomState.room) !== 'memory') return;
        if (roomState.room.game.phase !== 'memory_play') return;
        initMemoryBoard(roomState.room.code + ':' + roomState.room.game.roundNo + ':' + roomState.room.game.phase + ':manual');
      });

      drawGuessBtn.addEventListener('click', sendGuess);
      drawGuessInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          sendGuess();
        }
      });

      drawClearBtn.addEventListener('click', () => {
        if (!roomState || !roomState.room || !canDrawNow(roomState.room)) return;
        clearDrawCanvas();
        socket.emit('partyDrawClear');
      });

      drawCanvas.addEventListener('pointerdown', (e) => {
        if (!roomState || !roomState.room || !canDrawNow(roomState.room)) return;
        drawLineActive = true;
        drawLastPoint = pointOnCanvas(e);
      });

      drawCanvas.addEventListener('pointermove', (e) => {
        if (!drawLineActive) return;
        if (!roomState || !roomState.room || !canDrawNow(roomState.room)) return;

        const p = pointOnCanvas(e);
        const payload = {
          x0: drawLastPoint.x,
          y0: drawLastPoint.y,
          x1: p.x,
          y1: p.y,
          size: 4,
          color: '#2a0505',
        };
        drawLine(payload);
        socket.emit('partyDrawStroke', payload);
        drawLastPoint = p;
      });

      ['pointerup', 'pointercancel', 'pointerleave'].forEach((evt) => {
        drawCanvas.addEventListener(evt, () => {
          drawLineActive = false;
          drawLastPoint = null;
        });
      });

      socket.on('connect', () => {
        selfId = socket.id;
        socket.emit('partyListRooms');
        fetchLobbyFromHttp();
      });

      socket.on('partyLobby', (payload = {}) => {
        lobbyRooms = payload.rooms || [];
        if (!lobbyView.classList.contains('hidden')) {
          renderLobby();
        }
      });

      socket.on('partyState', (payload = {}) => {
        roomState = payload;
        renderRoom();
      });

      socket.on('partyError', (payload = {}) => {
        const msg = payload.message || '操作失败';
        if (lobbyView.classList.contains('hidden')) {
          setHint('room', msg, 'bad');
        } else {
          setHint('lobby', msg, 'bad');
        }
      });

      socket.on('partyDrawWord', (payload = {}) => {
        drawSecretWord = String(payload.word || '');
        if (roomState && roomState.room && roomState.room.game && activeGameType(roomState.room) === 'draw') {
          renderDraw(roomState.room);
        }
      });

      socket.on('partyDrawStroke', (payload = {}) => {
        if (!roomState || !roomState.room || !roomState.room.game || activeGameType(roomState.room) !== 'draw') return;
        drawLine(payload);
      });

      socket.on('partyDrawClear', () => {
        clearDrawCanvas();
      });

      socket.on('disconnect', () => {
        if (!roomView.classList.contains('hidden')) {
          setHint('room', '连接已断开，正在重连...', 'bad');
        } else {
          setHint('lobby', '连接已断开，正在重连...', 'bad');
        }
      });

      socket.on('connect_error', () => {
        if (!roomView.classList.contains('hidden')) {
          setHint('room', '连接失败，请检查网络', 'bad');
        } else {
          setHint('lobby', '连接失败，请检查网络', 'bad');
        }
      });

      loadName();
      nameInput.addEventListener('change', saveName);
      nameInput.addEventListener('blur', saveName);
      limitsText.textContent = gameLimitsText(gameSelect.value);

      ensureCanvas();
      clearDrawCanvas();
      renderLobby();
      openLobby();

      roomTimer = setInterval(updateRoomTimer, 200);
      lobbyPullTimer = setInterval(() => {
        if (!roomView.classList.contains('hidden')) return;
        fetchLobbyFromHttp();
      }, 3500);

      window.addEventListener('resize', () => {
        ensureCanvas();
      });

      socket.connect();
      fetchLobbyFromHttp();
    </script>
  </body>
</html>
