<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>é™¤å¤•è®°å¿†ç¿»ç¿»ä¹æ¥åŠ›</title>
    <style>
      :root {
        --bg-a: #1f0a08;
        --bg-b: #651516;
        --panel: rgba(255, 239, 214, 0.12);
        --panel-strong: rgba(255, 239, 214, 0.18);
        --line: rgba(255, 221, 160, 0.32);
        --text: #fff9ed;
        --muted: #ffdba3;
        --accent: #ffd25b;
        --accent-2: #ff9a35;
        --ok: #c9ffd8;
        --bad: #ffd1d1;
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        margin: 0;
        width: 100%;
        min-height: 100%;
        font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at 80% 0%, #8f2b1b 0%, transparent 36%),
          radial-gradient(circle at 0% 10%, #6b2018 0%, transparent 40%),
          linear-gradient(165deg, var(--bg-a), var(--bg-b));
      }

      body {
        display: flex;
        justify-content: center;
        padding: max(14px, env(safe-area-inset-top)) 12px max(18px, env(safe-area-inset-bottom));
      }

      .app {
        width: min(620px, 100%);
        display: grid;
        gap: 12px;
      }

      .panel {
        background: linear-gradient(150deg, var(--panel-strong), var(--panel));
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 14px;
      }

      h1,
      h2,
      p {
        margin: 0;
      }

      .hero {
        text-align: center;
        display: grid;
        gap: 8px;
      }

      .hero h1 {
        font-size: clamp(24px, 6.8vw, 36px);
      }

      .hero p {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.45;
      }

      .inputs {
        margin-top: 12px;
        display: grid;
        gap: 10px;
      }

      label {
        display: grid;
        gap: 8px;
        font-size: 13px;
        color: #ffe5bf;
        font-weight: 700;
      }

      textarea,
      input {
        width: 100%;
        border: 1px solid rgba(255, 221, 163, 0.34);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        padding: 10px 12px;
        font-size: 16px;
        outline: none;
      }

      textarea {
        min-height: 84px;
        resize: vertical;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .btn {
        border: 0;
        border-radius: 12px;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #621504;
        font-size: 16px;
        font-weight: 800;
        padding: 11px 14px;
        cursor: pointer;
      }

      .btn.secondary {
        border: 1px solid var(--line);
        color: #ffe4ba;
        background: rgba(255, 238, 202, 0.14);
      }

      .hidden {
        display: none !important;
      }

      .status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        color: #ffe4b4;
        font-size: 14px;
      }

      .focus {
        margin-top: 6px;
        font-size: 19px;
        font-weight: 700;
      }

      .scoreboard {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .score {
        border: 1px solid rgba(255, 216, 148, 0.24);
        border-radius: 10px;
        padding: 9px 11px;
        background: rgba(0, 0, 0, 0.18);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .score.active {
        border-color: rgba(255, 234, 169, 0.92);
        box-shadow: 0 0 0 1px rgba(255, 233, 160, 0.45) inset;
      }

      .score .meta {
        font-size: 12px;
        color: #ffe0b7;
      }

      .board {
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }

      .card {
        border: 1px solid rgba(255, 224, 169, 0.36);
        border-radius: 12px;
        aspect-ratio: 3 / 4;
        background: linear-gradient(145deg, rgba(124, 14, 14, 0.6), rgba(63, 6, 6, 0.72));
        color: #ffdca2;
        font-weight: 800;
        font-size: clamp(24px, 8vw, 36px);
        display: grid;
        place-items: center;
        transition: transform 0.12s ease, background 0.16s ease, color 0.16s ease;
      }

      .card:active {
        transform: scale(0.95);
      }

      .card.revealed,
      .card.matched {
        background: linear-gradient(150deg, #fff2ce, #ffd98e);
        color: #7a1808;
      }

      .card.matched {
        box-shadow: 0 0 0 1px rgba(255, 244, 197, 0.68) inset;
      }

      .hint {
        margin-top: 8px;
        min-height: 22px;
        text-align: center;
        font-weight: 700;
      }

      .hint.ok {
        color: var(--ok);
      }

      .hint.bad {
        color: var(--bad);
      }

      .results {
        display: grid;
        gap: 8px;
      }

      .result {
        border: 1px solid rgba(255, 219, 152, 0.28);
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .result.top {
        border-color: rgba(255, 233, 160, 0.9);
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(24, 6, 5, 0.84);
        display: grid;
        place-items: center;
        padding: 16px;
        z-index: 9;
      }

      .overlay-card {
        width: min(430px, 100%);
        text-align: center;
        display: grid;
        gap: 11px;
      }

      .overlay-card p {
        line-height: 1.5;
        color: #ffe0b2;
      }

      .footer {
        text-align: center;
        color: #ffd8a6;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section id="setup" class="panel">
        <header class="hero">
          <h1>é™¤å¤•è®°å¿†ç¿»ç¿»ä¹æ¥åŠ›</h1>
          <p>å¤šäººè½®æµä¼ æ‰‹æœºã€‚æ¯å›åˆé™æ—¶ç¿»ç‰Œæ‰¾å¯¹å­ï¼ŒåŒ¹é…æˆåŠŸå¾—åˆ†ï¼Œè¿å¯¹æœ‰åŠ æˆã€‚å…¨å‘˜æ‰“å®ŒåæŒ‰æ€»åˆ†æ’åã€‚</p>
        </header>
        <div class="inputs">
          <label>
            ç©å®¶åå•ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
            <textarea id="players" placeholder="ä¾‹å¦‚ï¼š\nå°èµµ\nå°é™ˆ\nä¸‰å”"></textarea>
          </label>
          <div class="row">
            <label>
              æ¯äººæ—¶é•¿ï¼ˆç§’ï¼‰
              <input id="turnSeconds" type="number" min="12" max="60" value="22" />
            </label>
            <label>
              å›åˆæ•°
              <input id="rounds" type="number" min="1" max="5" value="2" />
            </label>
          </div>
          <button id="start" class="btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
      </section>

      <section id="game" class="panel hidden">
        <div class="status">
          <span id="roundInfo">ç¬¬ 1 / 2 å›åˆ</span>
          <span id="timeInfo">å‰©ä½™ 22 ç§’</span>
        </div>
        <p id="focus" class="focus">å½“å‰ç©å®¶ï¼š-</p>
        <div id="scoreboard" class="scoreboard"></div>
        <div id="board" class="board"></div>
        <p id="hint" class="hint"></p>
      </section>

      <section id="result" class="panel hidden">
        <h2 style="text-align: center; margin-bottom: 10px">æ–°æ˜¥è®°å¿†æ¦œ</h2>
        <div id="resultList" class="results"></div>
        <div class="row" style="margin-top: 12px">
          <button id="again" class="btn">å†æ¥ä¸€å±€</button>
          <button id="back" class="btn secondary">ä¿®æ”¹é…ç½®</button>
        </div>
      </section>

      <p class="footer">å»ºè®®å…¨å±æ˜¾ç¤ºï¼Œä¼ æ‰‹æœºæ›´æ²‰æµ¸ã€‚</p>
    </main>

    <div id="overlay" class="overlay hidden">
      <div class="panel overlay-card">
        <h2 id="overlayTitle">å‡†å¤‡å¼€å§‹</h2>
        <p id="overlayDesc">æŠŠæ‰‹æœºäº¤ç»™ä¸‹ä¸€ä½ç©å®¶ï¼Œç„¶åç‚¹å‡»å¼€å§‹ã€‚</p>
        <button id="overlayBtn" class="btn">å¼€å§‹æœ¬å›åˆ</button>
      </div>
    </div>

    <script>
      const SYMBOLS = ['ç¦', 'æ˜¥', 'è´¢', 'å–œ', 'å®‰', 'ç¯', 'æ—º', 'å›¢'];
      const MAX_PLAYERS = 12;

      const setupEl = document.getElementById('setup');
      const gameEl = document.getElementById('game');
      const resultEl = document.getElementById('result');
      const playersEl = document.getElementById('players');
      const turnSecondsEl = document.getElementById('turnSeconds');
      const roundsEl = document.getElementById('rounds');
      const startEl = document.getElementById('start');
      const roundInfoEl = document.getElementById('roundInfo');
      const timeInfoEl = document.getElementById('timeInfo');
      const focusEl = document.getElementById('focus');
      const scoreboardEl = document.getElementById('scoreboard');
      const boardEl = document.getElementById('board');
      const hintEl = document.getElementById('hint');
      const resultListEl = document.getElementById('resultList');
      const againEl = document.getElementById('again');
      const backEl = document.getElementById('back');
      const overlayEl = document.getElementById('overlay');
      const overlayTitleEl = document.getElementById('overlayTitle');
      const overlayDescEl = document.getElementById('overlayDesc');
      const overlayBtnEl = document.getElementById('overlayBtn');

      let game = null;
      let timer = null;

      function shuffle(list) {
        const arr = [...list];
        for (let i = arr.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          const tmp = arr[i];
          arr[i] = arr[j];
          arr[j] = tmp;
        }
        return arr;
      }

      function parsePlayers() {
        const names = playersEl.value
          .split(/\n|,|ï¼Œ|ã€/g)
          .map((s) => s.trim())
          .filter(Boolean)
          .slice(0, MAX_PLAYERS);
        const out = [];
        const used = new Set();
        for (const name of names) {
          let n = name;
          let i = 2;
          while (used.has(n)) {
            n = name + i;
            i += 1;
          }
          used.add(n);
          out.push(n);
        }
        return out;
      }

      function createPlayers(names) {
        return names.map((name) => ({
          name,
          score: 0,
          combo: 0,
          bestCombo: 0,
          hits: 0,
          misses: 0,
          clears: 0
        }));
      }

      function makeDeck() {
        const pool = [...SYMBOLS, ...SYMBOLS];
        return shuffle(pool).map((symbol, idx) => ({
          id: idx + 1,
          symbol,
          revealed: false,
          matched: false
        }));
      }

      function currentPlayer() {
        return game.players[game.playerIndex];
      }

      function setHint(text, type) {
        hintEl.textContent = text;
        hintEl.className = 'hint ' + (type || '');
      }

      function vibrate(pattern) {
        if (navigator.vibrate) {
          navigator.vibrate(pattern);
        }
      }

      function renderScoreboard() {
        scoreboardEl.innerHTML = '';
        game.players.forEach((p, idx) => {
          const row = document.createElement('div');
          row.className = 'score' + (idx === game.playerIndex ? ' active' : '');
          row.innerHTML =
            '<div><strong>' +
            p.name +
            '</strong><div class="meta">è¿å‡» ' +
            p.combo +
            ' ï½œ æ¸…ç›˜ ' +
            p.clears +
            '</div></div><strong>' +
            p.score +
            ' åˆ†</strong>';
          scoreboardEl.appendChild(row);
        });
      }

      function renderBoard() {
        boardEl.innerHTML = '';
        game.deck.forEach((card, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'card' + (card.revealed ? ' revealed' : '') + (card.matched ? ' matched' : '');
          btn.textContent = card.revealed || card.matched ? card.symbol : 'å›';
          btn.addEventListener('click', () => onCardTap(idx));
          boardEl.appendChild(btn);
        });
      }

      function updateTopStatus() {
        roundInfoEl.textContent = 'ç¬¬ ' + game.round + ' / ' + game.totalRounds + ' å›åˆ';
        focusEl.textContent = 'å½“å‰ç©å®¶ï¼š' + currentPlayer().name;
      }

      function allMatched() {
        return game.deck.every((c) => c.matched);
      }

      function onCardTap(index) {
        if (!game || !game.running || game.locked) {
          return;
        }

        const card = game.deck[index];
        if (card.matched || card.revealed) {
          return;
        }

        card.revealed = true;
        renderBoard();

        if (game.firstPick === null) {
          game.firstPick = index;
          return;
        }

        const firstIndex = game.firstPick;
        const first = game.deck[firstIndex];
        const second = card;
        const player = currentPlayer();
        game.locked = true;

        if (first.symbol === second.symbol) {
          setTimeout(() => {
            first.matched = true;
            second.matched = true;
            player.hits += 1;
            player.combo += 1;
            player.bestCombo = Math.max(player.bestCombo, player.combo);
            const comboBonus = Math.floor(player.combo / 2);
            const gain = 2 + comboBonus;
            player.score += gain;
            setHint('é…å¯¹æˆåŠŸ +' + gain, 'ok');
            vibrate(20);

            game.firstPick = null;
            game.locked = false;

            if (allMatched()) {
              const bonus = Math.max(0, game.timeLeft);
              player.score += bonus;
              player.clears += 1;
              player.combo += 1;
              player.bestCombo = Math.max(player.bestCombo, player.combo);
              setHint('æ•´ç›˜æ¸…ç©ºï¼æ—¶é—´å¥–åŠ± +' + bonus, 'ok');
              game.deck = makeDeck();
              game.firstPick = null;
            }

            renderScoreboard();
            renderBoard();
          }, 250);
        } else {
          player.misses += 1;
          player.combo = 0;
          player.score = Math.max(0, player.score - 1);
          setHint('ç¿»é”™äº† -1', 'bad');
          vibrate([12, 25, 12]);

          setTimeout(() => {
            first.revealed = false;
            second.revealed = false;
            game.firstPick = null;
            game.locked = false;
            renderScoreboard();
            renderBoard();
          }, 520);
        }
      }

      function startTimer() {
        if (timer) {
          clearInterval(timer);
        }
        game.timeLeft = game.turnSeconds;
        timeInfoEl.textContent = 'å‰©ä½™ ' + game.timeLeft + ' ç§’';

        timer = setInterval(() => {
          game.timeLeft -= 1;
          timeInfoEl.textContent = 'å‰©ä½™ ' + Math.max(0, game.timeLeft) + ' ç§’';
          if (game.timeLeft <= 0) {
            clearInterval(timer);
            timer = null;
            game.running = false;
            endTurn();
          }
        }, 1000);
      }

      function showOverlay() {
        const p = currentPlayer();
        overlayTitleEl.textContent = 'è¯·æŠŠæ‰‹æœºäº¤ç»™ ' + p.name;
        overlayDescEl.textContent =
          'ç¬¬ ' + game.round + ' / ' + game.totalRounds + ' å›åˆï¼Œé™æ—¶ ' + game.turnSeconds + ' ç§’ï¼Œæ‰¾å¯¹å­æ‹¿åˆ†ã€‚';
        overlayEl.classList.remove('hidden');
      }

      function beginTurn() {
        overlayEl.classList.add('hidden');
        game.deck = makeDeck();
        game.firstPick = null;
        game.locked = false;
        game.running = true;
        updateTopStatus();
        renderScoreboard();
        renderBoard();
        setHint('', '');
        startTimer();
      }

      function endTurn() {
        setHint(currentPlayer().name + ' å›åˆç»“æŸ', 'ok');

        const lastPlayer = game.playerIndex === game.players.length - 1;
        if (lastPlayer) {
          game.playerIndex = 0;
          game.round += 1;
        } else {
          game.playerIndex += 1;
        }

        if (game.round > game.totalRounds) {
          finishGame();
          return;
        }

        setTimeout(() => {
          updateTopStatus();
          renderScoreboard();
          showOverlay();
        }, 600);
      }

      function finishGame() {
        game.running = false;
        if (timer) {
          clearInterval(timer);
          timer = null;
        }

        gameEl.classList.add('hidden');
        resultEl.classList.remove('hidden');

        const ranking = [...game.players].sort((a, b) => b.score - a.score);
        resultListEl.innerHTML = '';

        ranking.forEach((p, idx) => {
          const medal = idx === 0 ? 'ğŸ†' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : idx + 1 + '.';
          const row = document.createElement('div');
          row.className = 'result' + (idx === 0 ? ' top' : '');
          row.innerHTML =
            '<div><strong>' +
            medal +
            ' ' +
            p.name +
            '</strong><div class="meta">é…å¯¹ ' +
            p.hits +
            ' æ¬¡ Â· å¤±è¯¯ ' +
            p.misses +
            ' æ¬¡ Â· æœ€é«˜è¿å‡» ' +
            p.bestCombo +
            ' Â· æ¸…ç›˜ ' +
            p.clears +
            '</div></div><strong>' +
            p.score +
            ' åˆ†</strong>';
          resultListEl.appendChild(row);
        });
      }

      function launchGame() {
        const names = parsePlayers();
        const turnSeconds = Number(turnSecondsEl.value);
        const rounds = Number(roundsEl.value);

        if (names.length < 2) {
          alert('è‡³å°‘éœ€è¦ 2 åç©å®¶ã€‚');
          return;
        }
        if (!Number.isInteger(turnSeconds) || turnSeconds < 12 || turnSeconds > 60) {
          alert('æ¯äººæ—¶é•¿è¯·è®¾ç½®åœ¨ 12-60 ç§’ã€‚');
          return;
        }
        if (!Number.isInteger(rounds) || rounds < 1 || rounds > 5) {
          alert('å›åˆæ•°è¯·è®¾ç½®åœ¨ 1-5 å›åˆã€‚');
          return;
        }

        game = {
          players: createPlayers(names),
          turnSeconds,
          totalRounds: rounds,
          round: 1,
          playerIndex: 0,
          running: false,
          timeLeft: turnSeconds,
          deck: [],
          firstPick: null,
          locked: false
        };

        setupEl.classList.add('hidden');
        resultEl.classList.add('hidden');
        gameEl.classList.remove('hidden');

        updateTopStatus();
        renderScoreboard();
        showOverlay();
      }

      startEl.addEventListener('click', launchGame);
      overlayBtnEl.addEventListener('click', beginTurn);

      againEl.addEventListener('click', () => {
        if (!game) {
          return;
        }
        launchGame();
      });

      backEl.addEventListener('click', () => {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        overlayEl.classList.add('hidden');
        gameEl.classList.add('hidden');
        resultEl.classList.add('hidden');
        setupEl.classList.remove('hidden');
        game = null;
      });

      playersEl.value = 'å°èµµ\nå°é™ˆ\nä¸‰å”';
    </script>
  </body>
</html>
