<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>除夕联机小游戏派对</title>
    <style>
      :root {
        --bg-0: #240707;
        --bg-1: #6c1312;
        --line: rgba(255, 220, 153, 0.35);
        --panel: rgba(255, 240, 216, 0.12);
        --panel-strong: rgba(255, 240, 216, 0.2);
        --text: #fff8ec;
        --muted: #ffdca6;
        --ok: #d0ffd8;
        --bad: #ffd1d1;
        --gold: #ffd35a;
        --orange: #ff9f36;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        margin: 0;
        width: 100%;
        min-height: 100%;
        font-family: "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
        color: var(--text);
        background: radial-gradient(circle at 10% 10%, #8e1f16 0%, transparent 36%),
          radial-gradient(circle at 88% 4%, #a03517 0%, transparent 28%),
          linear-gradient(165deg, var(--bg-0), var(--bg-1));
      }

      body {
        display: flex;
        justify-content: center;
        padding: max(14px, env(safe-area-inset-top)) 12px max(16px, env(safe-area-inset-bottom));
      }

      .app {
        width: min(680px, 100%);
        display: grid;
        gap: 12px;
      }

      .panel {
        border: 1px solid var(--line);
        border-radius: 16px;
        background: linear-gradient(150deg, var(--panel-strong), var(--panel));
        padding: 14px;
      }

      .hero {
        text-align: center;
        display: grid;
        gap: 8px;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(24px, 7vw, 36px);
      }

      .hero p {
        margin: 0;
        color: var(--muted);
        line-height: 1.5;
        font-size: 14px;
      }

      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .inputs {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      label {
        display: grid;
        gap: 7px;
        font-size: 13px;
        color: #ffe8c5;
        font-weight: 700;
      }

      input,
      select {
        width: 100%;
        border: 1px solid rgba(255, 221, 164, 0.35);
        border-radius: 12px;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.24);
        color: var(--text);
        font-size: 16px;
        outline: none;
      }

      .btn {
        border: 0;
        border-radius: 12px;
        padding: 11px 13px;
        font-size: 16px;
        font-weight: 800;
        cursor: pointer;
        background: linear-gradient(120deg, var(--gold), var(--orange));
        color: #661805;
      }

      .btn.secondary {
        background: rgba(255, 240, 216, 0.12);
        border: 1px solid var(--line);
        color: #ffe6be;
      }

      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .small {
        font-size: 13px;
        color: var(--muted);
      }

      .rooms {
        display: grid;
        gap: 8px;
        margin-top: 8px;
      }

      .room-item {
        border: 1px solid rgba(255, 218, 145, 0.26);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.2);
        padding: 9px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .hidden {
        display: none !important;
      }

      .top {
        display: grid;
        gap: 8px;
      }

      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .code {
        font-size: 20px;
        font-weight: 800;
        letter-spacing: 1px;
      }

      .phase {
        padding: 4px 8px;
        border: 1px solid var(--line);
        border-radius: 999px;
        font-size: 12px;
        color: #ffe8c2;
      }

      .scoreboard {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .player {
        border: 1px solid rgba(255, 221, 156, 0.24);
        border-radius: 10px;
        padding: 8px 10px;
        background: rgba(0, 0, 0, 0.22);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .player.self {
        border-color: rgba(255, 236, 171, 0.92);
        box-shadow: 0 0 0 1px rgba(255, 236, 171, 0.45) inset;
      }

      .player .meta {
        font-size: 12px;
        color: #ffe3b9;
      }

      .question {
        margin-top: 10px;
        display: grid;
        gap: 10px;
      }

      .q-title {
        font-size: 20px;
        font-weight: 800;
      }

      .options {
        display: grid;
        gap: 8px;
      }

      .opt {
        width: 100%;
        text-align: left;
        border: 1px solid rgba(255, 220, 156, 0.35);
        background: rgba(0, 0, 0, 0.25);
        color: var(--text);
        border-radius: 12px;
        padding: 11px 12px;
        font-size: 15px;
        font-weight: 700;
      }

      .opt.correct {
        border-color: rgba(190, 255, 207, 0.95);
        background: rgba(76, 166, 95, 0.26);
      }

      .opt.wrong {
        border-color: rgba(255, 180, 180, 0.95);
        background: rgba(166, 76, 76, 0.26);
      }

      .hint {
        min-height: 22px;
        font-weight: 700;
      }

      .hint.ok {
        color: var(--ok);
      }

      .hint.bad {
        color: var(--bad);
      }

      .timer {
        font-weight: 800;
      }

      .footer {
        text-align: center;
        color: #ffd8a4;
        font-size: 12px;
      }

      @media (max-width: 520px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section id="lobbyView" class="panel">
        <div class="hero">
          <h1>除夕联机小游戏派对</h1>
          <p>每个人用自己的手机加入同一房间。支持多个小游戏模式：新春知识、心算冲刺、找字手速。</p>
        </div>

        <div class="inputs">
          <label>
            你的昵称
            <input id="nameInput" maxlength="16" placeholder="例如：阿明" />
          </label>
          <div class="grid2">
            <label>
              房间名（创建时）
              <input id="titleInput" maxlength="24" placeholder="我们家除夕局" />
            </label>
            <label>
              房间码（加入时）
              <input id="codeInput" maxlength="6" placeholder="输入6位房间码" />
            </label>
          </div>
          <div class="grid2">
            <label>
              题目数（3-12）
              <input id="roundInput" type="number" min="3" max="12" value="8" />
            </label>
            <label>
              每题时长（8-25秒）
              <input id="secInput" type="number" min="8" max="25" value="12" />
            </label>
          </div>
          <label>
            小游戏模式
            <select id="modeInput">
              <option value="mix">混合小游戏（推荐）</option>
              <option value="quiz">新春知识题</option>
              <option value="math">心算冲刺</option>
              <option value="find">找字手速</option>
            </select>
          </label>
          <div class="grid2">
            <button id="createBtn" class="btn">创建房间</button>
            <button id="joinBtn" class="btn secondary">加入房间</button>
          </div>
          <button id="refreshBtn" class="btn secondary">刷新房间列表</button>
        </div>

        <p class="small" style="margin-top: 12px">当前可加入房间：</p>
        <div id="roomList" class="rooms"></div>
      </section>

      <section id="roomView" class="panel hidden">
        <div class="top">
          <div class="row">
            <div>
              <div id="roomCode" class="code">------</div>
              <div id="roomTitle" class="small">房间</div>
            </div>
            <div class="row">
              <span id="phaseTag" class="phase">等待开始</span>
              <button id="copyBtn" class="btn secondary">复制房间码</button>
              <button id="leaveBtn" class="btn secondary">离开</button>
            </div>
          </div>

          <div class="row">
            <div id="roundText" class="small">第 0 / 0 题</div>
            <div id="timerText" class="timer">-- 秒</div>
          </div>

          <div class="row">
            <div id="hostText" class="small">房主：-</div>
            <div id="modeText" class="small">模式：-</div>
            <button id="startBtn" class="btn hidden">房主开始</button>
            <button id="resetBtn" class="btn secondary hidden">回到大厅</button>
          </div>
        </div>

        <div id="scoreboard" class="scoreboard"></div>

        <div id="questionWrap" class="question hidden">
          <div id="kindText" class="small">当前小游戏：-</div>
          <div id="questionText" class="q-title">题目</div>
          <div id="options" class="options"></div>
        </div>

        <p id="hint" class="hint"></p>
      </section>

      <p class="footer">建议：房主把房间码发到群里，大家各自打开链接加入。</p>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const MODE_TEXT = {
        mix: '混合小游戏',
        quiz: '新春知识题',
        math: '心算冲刺',
        find: '找字手速'
      };

      const lobbyView = document.getElementById('lobbyView');
      const roomView = document.getElementById('roomView');
      const nameInput = document.getElementById('nameInput');
      const titleInput = document.getElementById('titleInput');
      const codeInput = document.getElementById('codeInput');
      const roundInput = document.getElementById('roundInput');
      const secInput = document.getElementById('secInput');
      const modeInput = document.getElementById('modeInput');
      const createBtn = document.getElementById('createBtn');
      const joinBtn = document.getElementById('joinBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const roomList = document.getElementById('roomList');

      const roomCode = document.getElementById('roomCode');
      const roomTitle = document.getElementById('roomTitle');
      const phaseTag = document.getElementById('phaseTag');
      const roundText = document.getElementById('roundText');
      const timerText = document.getElementById('timerText');
      const hostText = document.getElementById('hostText');
      const modeText = document.getElementById('modeText');
      const copyBtn = document.getElementById('copyBtn');
      const leaveBtn = document.getElementById('leaveBtn');
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const scoreboard = document.getElementById('scoreboard');
      const questionWrap = document.getElementById('questionWrap');
      const kindText = document.getElementById('kindText');
      const questionText = document.getElementById('questionText');
      const options = document.getElementById('options');
      const hint = document.getElementById('hint');

      const PHASE_TEXT = {
        lobby: '等待开始',
        question: '答题中',
        reveal: '揭晓中',
        finished: '已结束'
      };

      let state = null;
      let lobbyRooms = [];
      let timerLoop = null;
      let selfId = '';

      function saveName() {
        localStorage.setItem('party_quiz_name', nameInput.value.trim());
      }

      function loadName() {
        const n = localStorage.getItem('party_quiz_name') || '';
        if (n) nameInput.value = n;
      }

      function setHint(text, type) {
        hint.textContent = text;
        hint.className = 'hint ' + (type || '');
      }

      function formatPhase(phase) {
        return PHASE_TEXT[phase] || phase;
      }

      function formatMode(mode, modeLabel) {
        return modeLabel || MODE_TEXT[mode] || MODE_TEXT.mix;
      }

      function shortTime(ms) {
        return Math.max(0, Math.ceil(ms / 1000));
      }

      function copyText(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
            setHint('房间码已复制', 'ok');
          });
          return;
        }
        setHint('复制失败，请手动复制', 'bad');
      }

      function openRoomView() {
        lobbyView.classList.add('hidden');
        roomView.classList.remove('hidden');
      }

      function openLobbyView() {
        roomView.classList.add('hidden');
        lobbyView.classList.remove('hidden');
      }

      function renderLobby() {
        roomList.innerHTML = '';
        if (!lobbyRooms.length) {
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = '暂无可加入房间';
          roomList.appendChild(empty);
          return;
        }

        lobbyRooms.forEach((room) => {
          const item = document.createElement('div');
          item.className = 'room-item';
          item.innerHTML =
            '<div><strong>' +
            room.title +
            '</strong><div class="small">房间码：' +
            room.code +
            ' ｜ ' +
            room.players +
            ' 人 ｜ ' +
            formatMode(room.mode, room.modeLabel) +
            ' ｜ ' +
            formatPhase(room.phase) +
            '</div></div><button class="btn secondary" data-code="' +
            room.code +
            '">加入</button>';
          const btn = item.querySelector('button');
          btn.addEventListener('click', () => {
            codeInput.value = room.code;
            joinRoom();
          });
          roomList.appendChild(item);
        });
      }

      function renderScoreboard(room) {
        const sorted = [...room.players].sort((a, b) => b.score - a.score);
        scoreboard.innerHTML = '';
        sorted.forEach((p) => {
          const row = document.createElement('div');
          row.className = 'player' + (p.id === selfId ? ' self' : '');
          row.innerHTML =
            '<div><strong>' +
            p.name +
            '</strong><div class="meta">答对 ' +
            p.correct +
            ' · 答错 ' +
            p.wrong +
            (p.answered ? ' · 已作答' : '') +
            '</div></div><strong>' +
            p.score +
            ' 分</strong>';
          scoreboard.appendChild(row);
        });
      }

      function renderQuestion(room) {
        const q = room.question;
        if (!q) {
          questionWrap.classList.add('hidden');
          kindText.textContent = '当前小游戏：' + formatMode(room.mode, room.modeLabel);
          return;
        }

        questionWrap.classList.remove('hidden');
        kindText.textContent = '当前小游戏：' + (q.label || formatMode(room.mode, room.modeLabel));
        questionText.textContent = q.text;
        options.innerHTML = '';

        const me = room.players.find((p) => p.id === selfId);
        const answered = Boolean(me && me.answered);

        q.options.forEach((text, idx) => {
          const btn = document.createElement('button');
          btn.className = 'opt';
          btn.type = 'button';
          btn.textContent = String.fromCharCode(65 + idx) + '. ' + text;

          if (room.phase === 'question') {
            btn.disabled = answered;
            btn.addEventListener('click', () => {
              socket.emit('partyAnswer', { choice: idx });
            });
          }

          if (room.phase === 'reveal' || room.phase === 'finished') {
            if (idx === q.correctIndex) {
              btn.classList.add('correct');
            }
            if (me && me.answerChoice === idx && idx !== q.correctIndex) {
              btn.classList.add('wrong');
            }
            btn.disabled = true;
          }

          options.appendChild(btn);
        });
      }

      function renderRoom() {
        if (!state || !state.room) {
          openLobbyView();
          return;
        }

        const room = state.room;
        openRoomView();

        roomCode.textContent = room.code;
        roomTitle.textContent = room.title;
        phaseTag.textContent = formatPhase(room.phase);
        roundText.textContent =
          room.roundIndex >= 0
            ? '第 ' + room.roundNo + ' / ' + room.totalRounds + ' 题'
            : '共 ' + room.totalRounds + ' 题';

        hostText.textContent = '房主：' + room.hostName;
        modeText.textContent = '模式：' + formatMode(room.mode, room.modeLabel);

        const amHost = room.hostId === selfId;
        startBtn.classList.toggle('hidden', !(amHost && (room.phase === 'lobby' || room.phase === 'finished')));
        resetBtn.classList.toggle('hidden', !(amHost && room.phase !== 'lobby'));

        renderScoreboard(room);
        renderQuestion(room);

        if (room.phase === 'question') {
          const me = room.players.find((p) => p.id === selfId);
          if (me && me.answered) {
            setHint('已提交答案，等待其他玩家…', 'ok');
          } else {
            setHint('请选择一个选项提交答案', '');
          }
        } else if (room.phase === 'reveal') {
          const me = room.players.find((p) => p.id === selfId);
          if (me) {
            if (me.lastGain > 0) {
              setHint('本题得分 +' + me.lastGain, 'ok');
            } else {
              setHint('本题未得分', 'bad');
            }
          }
        } else if (room.phase === 'finished') {
          setHint('本局已结束，房主可点击“回到大厅”重开。', 'ok');
        } else {
          setHint('等待房主开始', '');
        }
      }

      function startTimerLoop() {
        if (timerLoop) clearInterval(timerLoop);
        timerLoop = setInterval(() => {
          if (!state || !state.room) {
            timerText.textContent = '-- 秒';
            return;
          }
          const room = state.room;
          if (room.phase !== 'question' || !room.roundEndsAt) {
            timerText.textContent = '-- 秒';
            return;
          }
          timerText.textContent = shortTime(room.roundEndsAt - Date.now()) + ' 秒';
        }, 200);
      }

      function validateName() {
        const name = nameInput.value.trim();
        if (!name) {
          setHint('请先输入昵称', 'bad');
          return false;
        }
        saveName();
        return true;
      }

      function createRoom() {
        if (!validateName()) return;
        socket.emit('partyCreateRoom', {
          name: nameInput.value.trim(),
          title: titleInput.value.trim(),
          totalRounds: Number(roundInput.value),
          roundSeconds: Number(secInput.value),
          mode: modeInput.value
        });
      }

      function joinRoom() {
        if (!validateName()) return;
        const code = codeInput.value.toUpperCase().trim();
        if (!code) {
          setHint('请输入房间码', 'bad');
          return;
        }
        socket.emit('partyJoinRoom', {
          code,
          name: nameInput.value.trim()
        });
      }

      createBtn.addEventListener('click', createRoom);
      joinBtn.addEventListener('click', joinRoom);
      refreshBtn.addEventListener('click', () => socket.emit('partyListRooms'));

      copyBtn.addEventListener('click', () => {
        if (!state || !state.room) return;
        copyText(state.room.code);
      });

      leaveBtn.addEventListener('click', () => {
        socket.emit('partyLeaveRoom');
        state = null;
        openLobbyView();
        setHint('已离开房间', '');
      });

      startBtn.addEventListener('click', () => {
        socket.emit('partyStart');
      });

      resetBtn.addEventListener('click', () => {
        socket.emit('partyResetLobby');
      });

      socket.on('connect', () => {
        selfId = socket.id;
        socket.emit('partyListRooms');
      });

      socket.on('partyLobby', (payload = {}) => {
        lobbyRooms = payload.rooms || [];
        renderLobby();
      });

      socket.on('partyState', (payload = {}) => {
        state = payload;
        renderRoom();
      });

      socket.on('partyError', (payload = {}) => {
        setHint(payload.message || '操作失败', 'bad');
      });

      loadName();
      nameInput.addEventListener('change', saveName);
      nameInput.addEventListener('blur', saveName);
      renderLobby();
      startTimerLoop();
    </script>
  </body>
</html>
